<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¦è½½å¤šæ¨¡æ€äº¤äº’ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        .container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            grid-template-rows: 80px 1fr;
            min-height: 100vh;
            gap: 15px;
            padding: 15px;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-bar {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            position: sticky;
            top: 15px;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(45deg, #00d4ff, #5b86e5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo::before {
            content: "ğŸš—";
            font-size: 32px;
        }

        .system-status {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 14px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.active { background: #00ff88; }
        .status-dot.warning { background: #ffaa00; }
        .status-dot.error { background: #ff4444; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ç”¨æˆ·ä¿¡æ¯å’Œé€€å‡ºæŒ‰é’® */
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: auto;
        }

        .user-name {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .logout-btn {
            padding: 6px 12px;
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 15px;
            color: #ff6b6b;
            text-decoration: none;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 107, 107, 0.3);
            transform: translateY(-1px);
        }

        .admin-link {
            padding: 6px 12px;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 15px;
            color: #00d4ff;
            text-decoration: none;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .admin-link:hover {
            background: rgba(0, 212, 255, 0.3);
            transform: translateY(-1px);
        }

        /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
        .control-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }

        .panel-section {
            margin-bottom: 30px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #00d4ff;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .control-button {
            background: linear-gradient(135deg, rgba(91, 134, 229, 0.2), rgba(0, 212, 255, 0.2));
            border: 1px solid rgba(91, 134, 229, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .control-button:hover {
            background: linear-gradient(135deg, rgba(91, 134, 229, 0.4), rgba(0, 212, 255, 0.4));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
        }

        .control-button.active {
            background: linear-gradient(135deg, #5b86e5, #00d4ff);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
        }

        /* å¯¼èˆªæ§åˆ¶ç»„ */
        .navigation-control {
            margin-top: 20px;
        }

        .destination-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            color: white;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .destination-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* ä¸­å¤®ä¸»æ˜¾ç¤ºåŒºåŸŸ */
        .main-display {
            display: grid;
            grid-template-rows: 0.6fr 0.4fr;
            gap: 15px;
            min-height: 520px;
        }

        /* åœ°å›¾æ˜¾ç¤ºåŒºåŸŸ */
        .navigation-section {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            position: relative;
            min-height: 500px;
            max-height: 500px;
        }

        .map-container {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0, 212, 255, 0.1), rgba(0, 0, 0, 0.8));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            min-height: 200px;
        }

        /* åœ°å›¾iframe */
        .map-frame {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 20px;
        }

        .map-placeholder {
            font-size: 48px;
            opacity: 0.5;
            animation: breathe 3s ease-in-out infinite;
            position: absolute;
            z-index: 1;
        }

        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            z-index: 2;
        }

        @keyframes breathe {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }

        .map-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 10;
        }

        .overlay-info {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 14px;
        }

        /* å¯¼èˆªçŠ¶æ€æŒ‡ç¤ºå™¨ */
        .navigation-status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 12px;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navigation-status.navigating {
            background: rgba(0, 123, 186, 0.8);
        }

        .navigation-status.ready {
            background: rgba(0, 255, 136, 0.8);
        }

        .navigation-status.error {
            background: rgba(255, 68, 68, 0.8);
        }

        .stop-navigation-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .music-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            min-height: 280px;
        }

        .now-playing {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .album-art {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .song-info h3 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .song-info p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
        }

        .music-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .music-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .music-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .music-btn.play {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #5b86e5, #00d4ff);
            font-size: 24px;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #5b86e5, #00d4ff);
            width: 35%;
            transition: width 0.3s ease;
        }

        .progress-time {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* å³ä¾§çŠ¶æ€é¢æ¿ */
        .status-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-card h4 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #00d4ff;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .status-value {
            font-weight: 600;
        }

        .temperature-display {
            text-align: center;
            padding: 20px;
        }

        .temp-value {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* å¯¼èˆªçŠ¶æ€å¡ç‰‡ */
        .navigation-status-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .navigation-status-card h4 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #00d4ff;
        }

        .navigation-info {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .navigation-info.navigating {
            color: #00ff88;
        }

        .navigation-info.ready {
            color: #ffaa00;
        }

        /* å‘½ä»¤å†å²å¡ç‰‡ */
        .command-history-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .command-history-card h4 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #00d4ff;
        }

        .command-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 13px;
        }

        .command-item:last-child {
            border-bottom: none;
        }

        .command-type {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            min-width: 40px;
            text-align: center;
            flex-shrink: 0;
        }

        .command-type.voice { background: rgba(255, 107, 107, 0.3); }
        .command-type.gesture { background: rgba(0, 212, 255, 0.3); }
        .command-type.system { background: rgba(0, 255, 136, 0.3); }
        .command-type.navigation { background: rgba(255, 165, 0, 0.3); }

        .command-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .command-time {
            font-size: 10px;
            opacity: 0.6;
            flex-shrink: 0;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1400px) {
            .container {
                grid-template-columns: 280px 1fr 320px;
            }
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: 80px auto auto auto;
                min-height: auto;
            }

            .main-display {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 1fr;
                min-height: 500px;
            }

            .control-panel, .status-panel {
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .main-display {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
                min-height: auto;
            }

            .container {
                padding: 15px;
                gap: 15px;
                grid-template-rows: 80px auto auto auto;
            }

            .navigation-section, .music-section {
                min-height: 250px;
            }

            .control-panel, .status-panel {
                max-height: none;
                overflow-y: visible;
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #5b86e5, #00d4ff);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #00d4ff, #5b86e5);
        }

        /* ç¡®ä¿åœ¨è¾ƒå°å±å¹•ä¸Šå†…å®¹å¯è§ */
        @media (max-height: 800px) {
            .container {
                min-height: auto;
            }

            .control-panel, .status-panel {
                max-height: 60vh;
            }

            .main-display {
                min-height: 500px;
            }
        }

        /* è¿æ¥çŠ¶æ€æç¤º */
        .connection-alert {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); }
            to { transform: translateX(-50%) translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="top-bar">
            <div class="logo">
                è½¦è½½æ™ºèƒ½ç³»ç»Ÿ
            </div>
            <div class="system-status">
                <div class="status-indicator">
                    <div class="status-dot active" id="systemDot"></div>
                    <span id="systemStatus">ç³»ç»Ÿè¿è¡Œä¸­</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot active" id="connectionDot"></div>
                    <span id="connectionStatus">å·²è¿æ¥</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot" id="navigationDot"></div>
                    <span id="navigationStatus">åœ°å›¾åŠ è½½ä¸­</span>
                </div>
                <div class="status-indicator">
                    <span id="systemTime">--:--:--</span>
                </div>

                <!-- ç”¨æˆ·ä¿¡æ¯å’Œæ“ä½œ -->
                <div class="user-info">
                    <span class="user-name">ç”¨æˆ·: <span id="currentUser">{{ current_user.username if current_user.is_authenticated else 'Guest' }}</span></span>
                    {% if current_user.is_authenticated and current_user.is_admin() %}
                    <a href="{{ url_for('admin_dashboard') }}" class="admin-link" target="_blank">ğŸ”§ ç®¡ç†åå°</a>
                    {% endif %}
                    <a href="{{ url_for('auth.logout') }}" class="logout-btn">é€€å‡ºç™»å½•</a>
                </div>
            </div>
        </header>

        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <aside class="control-panel">
            <!-- å¯¼èˆªæ§åˆ¶ -->
            <div class="panel-section">
                <h3 class="panel-title">ğŸ—ºï¸ å¯¼èˆªæ§åˆ¶</h3>
                <div class="navigation-control">
                    <input type="text" class="destination-input" id="destinationInput" placeholder="è¾“å…¥ç›®çš„åœ°ï¼Œå¦‚ï¼šå¤©æ´¥ç«™">
                    <div class="control-group">
                        <button class="control-button" id="startNavigationBtn">
                            <span>ğŸ§­</span> å¼€å§‹å¯¼èˆª
                        </button>
                        <button class="control-button" id="stopNavigationBtn">
                            <span>ğŸ›‘</span> åœæ­¢å¯¼èˆª
                        </button>
                        <button class="control-button" id="refreshMapBtn">
                            <span>ğŸ”„</span> åˆ·æ–°åœ°å›¾
                        </button>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <h3 class="panel-title">ğŸµ éŸ³ä¹æ§åˆ¶</h3>
                <div class="control-group">
                    <button class="control-button" id="playPauseBtn">
                        <span>â–¶ï¸</span> æ’­æ”¾/æš‚åœ
                    </button>
                    <button class="control-button" id="nextBtn">
                        <span>â­ï¸</span> ä¸‹ä¸€é¦–
                    </button>
                    <button class="control-button" id="prevBtn">
                        <span>â®ï¸</span> ä¸Šä¸€é¦–
                    </button>
                    <button class="control-button" id="shuffleBtn">
                        <span>ğŸ”€</span> éšæœºæ’­æ”¾
                    </button>
                </div>
            </div>

            <div class="panel-section">
                <h3 class="panel-title">ğŸŒ¡ï¸ ç©ºè°ƒæ§åˆ¶</h3>
                <div class="control-group">
                    <button class="control-button" id="acToggleBtn">
                        <span>â„ï¸</span> å¼€å…³ç©ºè°ƒ
                    </button>
                    <button class="control-button" id="tempUpBtn">
                        <span>ğŸ”º</span> å‡æ¸©
                    </button>
                    <button class="control-button" id="tempDownBtn">
                        <span>ğŸ”»</span> é™æ¸©
                    </button>
                </div>
            </div>

            <div class="panel-section">
                <h3 class="panel-title">ğŸš— è½¦çª—æ§åˆ¶</h3>
                <div class="control-group">
                    <button class="control-button" id="windowOpenBtn">
                        <span>ğŸ”½</span> å¼€å¯è½¦çª—
                    </button>
                    <button class="control-button" id="windowCloseBtn">
                        <span>ğŸ”¼</span> å…³é—­è½¦çª—
                    </button>
                </div>
            </div>

            <div class="panel-section">
                <h3 class="panel-title">ğŸ’¡ ç¯å…‰æ§åˆ¶</h3>
                <div class="control-group">
                    <button class="control-button" id="headlightsBtn">
                        <span>ğŸ’¡</span> å¤§ç¯
                    </button>
                    <button class="control-button" id="interiorBtn">
                        <span>ğŸ </span> å®¤å†…ç¯
                    </button>
                </div>
            </div>
        </aside>

        <!-- ä¸­å¤®ä¸»æ˜¾ç¤ºåŒºåŸŸ -->
        <main class="main-display">
            <!-- åœ°å›¾å¯¼èˆªåŒºåŸŸ -->
            <section class="navigation-section">
                <div class="map-container">
                    <!-- åœ°å›¾iframe -->
                    <iframe id="mapFrame" class="map-frame" src="/map" style="display: none;"></iframe>

                    <!-- åŠ è½½å ä½ç¬¦ -->
                    <div class="map-placeholder" id="mapPlaceholder">ğŸ—ºï¸</div>
                    <div class="map-loading" id="mapLoading">æ­£åœ¨åŠ è½½åœ°å›¾...</div>

                    <!-- åœ°å›¾å åŠ å±‚ -->
                    <div class="map-overlay">
                        <div class="overlay-info">
                            <div>å½“å‰ä½ç½®: <span id="currentLocation">å®šä½ä¸­...</span></div>
                        </div>
                        <div class="overlay-info">
                            <div>é©¾é©¶å‘˜çŠ¶æ€: <span id="driverState">æ­£å¸¸</span></div>
                            <div>æ‰‹åŠ¿: <span id="gestureState">æ— </span></div>
                        </div>
                    </div>

                    <!-- å¯¼èˆªçŠ¶æ€æŒ‡ç¤ºå™¨ -->
                    <div class="navigation-status ready" id="navigationStatusIndicator">
                        <span id="navigationStatusText">å¯¼èˆªç³»ç»Ÿå°±ç»ª</span>
                        <button class="stop-navigation-btn" id="quickStopBtn" style="display: none;">åœæ­¢å¯¼èˆª</button>
                    </div>
                </div>
            </section>

            <!-- éŸ³ä¹æ’­æ”¾åŒºåŸŸ -->
            <section class="music-section">
                <div class="now-playing">
                    <div class="album-art">ğŸµ</div>
                    <div class="song-info">
                        <h3 id="songTitle">æ™´å¤©</h3>
                        <p id="songArtist">å‘¨æ°ä¼¦</p>
                    </div>
                </div>

                <div class="music-controls">
                    <button class="music-btn" id="musicPrevBtn">â®ï¸</button>
                    <button class="music-btn play" id="musicPlayBtn">â–¶ï¸</button>
                    <button class="music-btn" id="musicNextBtn">â­ï¸</button>
                </div>

                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-time">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">4:30</span>
                    </div>
                </div>
            </section>
        </main>

        <!-- å³ä¾§çŠ¶æ€é¢æ¿ -->
        <aside class="status-panel">
            <!-- å¯¼èˆªçŠ¶æ€å¡ç‰‡ -->
            <div class="navigation-status-card">
                <h4>ğŸ§­ å¯¼èˆªçŠ¶æ€</h4>
                <div class="navigation-info" id="navCurrentLocation">å½“å‰ä½ç½®: å®šä½ä¸­...</div>
                <div class="navigation-info" id="navDestination">ç›®çš„åœ°: æœªè®¾ç½®</div>
                <div class="navigation-info" id="navDistance">è·ç¦»: --</div>
                <div class="navigation-info" id="navDuration">é¢„è®¡æ—¶é—´: --</div>
                <div class="navigation-info" id="navStatus">çŠ¶æ€: å°±ç»ª</div>
            </div>

            <div class="status-card">
                <h4>ğŸŒ¡ï¸ è½¦å†…ç¯å¢ƒ</h4>
                <div class="temperature-display">
                    <div class="temp-value" id="temperature">22Â°C</div>
                    <div>ç©ºè°ƒ: <span id="acStatus">å…³é—­</span></div>
                </div>
            </div>

            <div class="status-card">
                <h4>ğŸš— è½¦è¾†çŠ¶æ€</h4>
                <div class="status-item">
                    <span>å¼•æ“</span>
                    <span class="status-value" id="engineStatus">å¯åŠ¨</span>
                </div>
                <div class="status-item">
                    <span>ç‡ƒæ²¹</span>
                    <span class="status-value" id="fuelLevel">75%</span>
                </div>
                <div class="status-item">
                    <span>é€Ÿåº¦</span>
                    <span class="status-value" id="speed">0 km/h</span>
                </div>
                <div class="status-item">
                    <span>æ¡£ä½</span>
                    <span class="status-value" id="gear">P</span>
                </div>
            </div>

            <div class="status-card">
                <h4>ğŸ“Š ç³»ç»Ÿç›‘æ§</h4>
                <div class="status-item">
                    <span>CPU</span>
                    <span class="status-value" id="cpuUsage">35%</span>
                </div>
                <div class="status-item">
                    <span>å†…å­˜</span>
                    <span class="status-value" id="memoryUsage">42%</span>
                </div>
                <div class="status-item">
                    <span>æ¸©åº¦</span>
                    <span class="status-value" id="systemTemp">45Â°C</span>
                </div>
            </div>

            <div class="command-history-card">
                <h4>ğŸ“‹ æœ€è¿‘å‘½ä»¤</h4>
                <div style="margin-bottom: 10px;">
                    <button onclick="carSystem.testConnection()" style="
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        border: none;
                        border-radius: 8px;
                        color: white;
                        padding: 8px 16px;
                        cursor: pointer;
                        font-size: 12px;
                        margin-right: 5px;
                        margin-bottom: 5px;
                    ">æµ‹è¯•è¿æ¥</button>
                    <button onclick="carSystem.checkVoiceStatus()" style="
                        background: linear-gradient(135deg, #ff6b6b, #ffa500);
                        border: none;
                        border-radius: 8px;
                        color: white;
                        padding: 8px 16px;
                        cursor: pointer;
                        font-size: 12px;
                        margin-right: 5px;
                        margin-bottom: 5px;
                    ">è¯­éŸ³çŠ¶æ€</button>
                    <button onclick="carSystem.testVoiceCommand()" style="
                        background: linear-gradient(135deg, #00d4ff, #5b86e5);
                        border: none;
                        border-radius: 8px;
                        color: white;
                        padding: 8px 16px;
                        cursor: pointer;
                        font-size: 12px;
                        margin-right: 5px;
                        margin-bottom: 5px;
                    ">æµ‹è¯•è¯­éŸ³</button>
                    <button onclick="carSystem.checkNavigationStatus()" style="
                        background: linear-gradient(135deg, #00ff88, #32cd32);
                        border: none;
                        border-radius: 8px;
                        color: white;
                        padding: 8px 16px;
                        cursor: pointer;
                        font-size: 12px;
                        margin-bottom: 5px;
                    ">å¯¼èˆªçŠ¶æ€</button>
                </div>
                <div id="commandHistory">
                    <div class="command-item">
                        <span class="command-type voice">è¯­éŸ³</span>
                        <span class="command-text">æ’­æ”¾éŸ³ä¹</span>
                        <span class="command-time">15:30:24</span>
                    </div>
                    <div class="command-item">
                        <span class="command-type gesture">æ‰‹åŠ¿</span>
                        <span class="command-text">éŸ³é‡åŠ </span>
                        <span class="command-time">15:29:18</span>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- è¿æ¥çŠ¶æ€æç¤º -->
    <div class="connection-alert" id="connectionAlert">
        <span id="connectionAlertText">è¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨å°è¯•é‡è¿...</span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script>
        // ç³»ç»ŸçŠ¶æ€ç®¡ç†ï¼ˆè®¤è¯ç‰ˆæœ¬ï¼‰
        class CarSystemUI {
            constructor() {
                this.currentSong = {
                    title: "æ— éŸ³ä¹",
                    artist: "æœªçŸ¥",
                    album: "æœªçŸ¥ä¸“è¾‘",
                    file_path: "",
                    is_playing: false,
                    is_paused: false,
                    progress: 0,
                    duration: 0,
                    progress_percentage: 0,
                    volume: 50,
                    total_files: 0,
                    current_index: 0,
                    shuffle_mode: false,
                    repeat_mode: 'none',
                    current_time_str: '0:00',
                    total_time_str: '0:00',
                    playlist: []
                };

                this.systemData = {
                    temperature: 22,
                    acOn: false,
                    engineOn: true,
                    fuelLevel: 75,
                    speed: 0,
                    gear: "P"
                };

                this.navigationData = {
                    is_navigating: false,
                    current_location: null,
                    destination: null,
                    distance: 0,
                    duration: 0,
                    map_ready: false
                };

                this.commandHistory = [];
                this.socket = null;
                this.mapLoaded = false;
                this.connectionRetryCount = 0;
                this.maxRetries = 5;
                this.retryInterval = 3000; // 3ç§’

                this.init();
            }

            init() {
                this.initWebSocket();
                this.bindEvents();
                this.startTimeUpdate();
                this.startSystemMonitor();
                this.initMapDisplay();
                this.updateDisplay();
                this.loadNavigationStatus();
                this.checkAuthenticationStatus();
            }

            checkAuthenticationStatus() {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯
                fetch('/api/system_state')
                    .then(response => {
                        if (response.status === 401) {
                            // ç”¨æˆ·æœªè®¤è¯ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                            window.location.href = '/login';
                            return;
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data) {
                            console.log('âœ… ç”¨æˆ·è®¤è¯çŠ¶æ€æ­£å¸¸');
                        }
                    })
                    .catch(error => {
                        console.error('âŒ è®¤è¯çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
                        this.showConnectionAlert('è®¤è¯çŠ¶æ€æ£€æŸ¥å¤±è´¥');
                    });
            }

            initWebSocket() {
                console.log('ğŸ”Œ æ­£åœ¨åˆå§‹åŒ–WebSocketè¿æ¥...');

                if (typeof io === 'undefined') {
                    console.error('âŒ Socket.IOåº“æœªåŠ è½½!');
                    this.showNotification('Socket.IOåº“åŠ è½½å¤±è´¥', 'error');
                    this.updateConnectionStatus(false);
                    return;
                }

                try {
                    this.socket = io({
                        transports: ['websocket', 'polling'],
                        timeout: 20000,
                        forceNew: true,
                        reconnection: true,
                        reconnectionDelay: 1000,
                        reconnectionAttempts: 5,
                        maxHttpBufferSize: 1e6,
                        pingTimeout: 60000,
                        pingInterval: 25000
                    });

                    // éŸ³ä¹è¿›åº¦æ›´æ–°äº‹ä»¶
                    this.socket.on('music_progress', (data) => {
                        console.log('ğŸµ æ”¶åˆ°éŸ³ä¹è¿›åº¦æ›´æ–°:', data);
                        if (data && data.type === 'progress_update') {
                            this.currentSong.progress = data.progress || 0;
                            this.currentSong.progress_percentage = data.progress_percentage || 0;
                            this.currentSong.current_time_str = data.current_time_str || '0:00';
                            this.currentSong.total_time_str = data.total_time_str || '0:00';

                            const progressFill = document.getElementById('progressFill');
                            if (progressFill) {
                                progressFill.style.width = this.currentSong.progress_percentage + '%';
                            }

                            const currentTimeEl = document.getElementById('currentTime');
                            if (currentTimeEl) currentTimeEl.textContent = this.currentSong.current_time_str;

                            const totalTimeEl = document.getElementById('totalTime');
                            if (totalTimeEl) totalTimeEl.textContent = this.currentSong.total_time_str;
                        }
                    });

                    // è¿æ¥æˆåŠŸäº‹ä»¶
                    this.socket.on('connect', () => {
                        console.log('âœ… WebSocketå·²è¿æ¥åˆ°è½¦è½½ç³»ç»ŸæœåŠ¡å™¨');
                        console.log('è¿æ¥ID:', this.socket.id);
                        this.updateConnectionStatus(true);
                        this.hideConnectionAlert();
                        this.connectionRetryCount = 0;
                        this.showNotification('ç³»ç»Ÿå·²è¿æ¥', 'success');
                        this.requestSystemState();
                    });

                    // è¿æ¥æ–­å¼€äº‹ä»¶
                    this.socket.on('disconnect', (reason) => {
                        console.log('âŒ WebSocketè¿æ¥æ–­å¼€:', reason);
                        this.updateConnectionStatus(false);
                        this.showConnectionAlert('è¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨å°è¯•é‡è¿...');

                        if (reason === 'io server disconnect') {
                            this.showNotification('æœåŠ¡å™¨ä¸»åŠ¨æ–­å¼€è¿æ¥', 'error');
                        } else if (reason === 'io client disconnect') {
                            this.showNotification('å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥', 'info');
                        } else {
                            this.showNotification('è¿æ¥æ–­å¼€: ' + reason, 'warning');
                        }

                        // è‡ªåŠ¨é‡è¿é€»è¾‘
                        if (reason !== 'io client disconnect' && this.connectionRetryCount < this.maxRetries) {
                            setTimeout(() => {
                                if (!this.socket.connected) {
                                    console.log(`ğŸ”„ å°è¯•é‡æ–°è¿æ¥WebSocket... (${this.connectionRetryCount + 1}/${this.maxRetries})`);
                                    this.connectionRetryCount++;
                                    this.socket.connect();
                                }
                            }, this.retryInterval);
                        } else if (this.connectionRetryCount >= this.maxRetries) {
                            this.showConnectionAlert('è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                        }
                    });

                    // è¿æ¥é”™è¯¯äº‹ä»¶
                    this.socket.on('connect_error', (error) => {
                        console.error('âŒ WebSocketè¿æ¥é”™è¯¯:', error);
                        this.updateConnectionStatus(false);
                        this.showConnectionAlert('è¿æ¥é”™è¯¯: ' + error.message);
                        this.showNotification('è¿æ¥é”™è¯¯: ' + error.message, 'error');
                    });

                    // ç³»ç»Ÿæ›´æ–°äº‹ä»¶
                    this.socket.on('system_update', (data) => {
                        console.log('ğŸ“¨ æ”¶åˆ°ç³»ç»Ÿæ›´æ–°æ•°æ®:', data);
                        if (!data) {
                            console.warn('âš ï¸ æ”¶åˆ°ç©ºçš„æ›´æ–°æ•°æ®');
                            return;
                        }
                        this.handleSystemUpdate(data);
                    });

                    // é€šç”¨é”™è¯¯äº‹ä»¶
                    this.socket.on('error', (error) => {
                        console.error('âŒ WebSocketé”™è¯¯:', error);
                        this.showNotification('WebSocketé”™è¯¯', 'error');
                    });

                    // æµ‹è¯•äº‹ä»¶
                    this.socket.on('test_message', (data) => {
                        console.log('ğŸ§ª æ”¶åˆ°æµ‹è¯•æ¶ˆæ¯:', data);
                        this.showNotification('æ”¶åˆ°æµ‹è¯•æ¶ˆæ¯: ' + JSON.stringify(data), 'info');
                    });

                } catch (error) {
                    console.error('âŒ WebSocketåˆå§‹åŒ–å¤±è´¥:', error);
                    this.updateConnectionStatus(false);
                    this.showNotification('WebSocketåˆå§‹åŒ–å¤±è´¥', 'error');
                    this.showConnectionAlert('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                }
            }

            showConnectionAlert(message) {
                const alert = document.getElementById('connectionAlert');
                const alertText = document.getElementById('connectionAlertText');
                alertText.textContent = message;
                alert.style.display = 'block';
            }

            hideConnectionAlert() {
                const alert = document.getElementById('connectionAlert');
                alert.style.display = 'none';
            }

            // ============ æ ¸å¿ƒæ–¹æ³•ï¼ˆä¸åŸç‰ˆæœ¬ç›¸åŒä½†å¢åŠ äº†è®¤è¯æ£€æŸ¥ï¼‰ ============
            handleSystemUpdate(data) {
                console.log('ğŸ”„ å¼€å§‹å¤„ç†ç³»ç»ŸçŠ¶æ€æ›´æ–°:', data);

                if (!data) {
                    console.warn('âš ï¸ æ•°æ®ä¸ºç©ºï¼Œè·³è¿‡æ›´æ–°');
                    return;
                }

                if (data.state) {
                    console.log('ğŸ“Š æ›´æ–°ç³»ç»ŸçŠ¶æ€...');

                    // æ›´æ–°å¯¼èˆªçŠ¶æ€
                    if (data.state.navigation) {
                        console.log('ğŸ§­ æ›´æ–°å¯¼èˆªçŠ¶æ€:', data.state.navigation);
                        const oldNavigating = this.navigationData.is_navigating;
                        const oldDestination = this.navigationData.destination ? this.navigationData.destination.name : null;
                        this.updateNavigationStatus(data.state.navigation);
                        const newNavigating = data.state.navigation.is_navigating;
                        const newDestination = data.state.navigation.destination ? data.state.navigation.destination.name : null;
                        const shouldRefreshMap = (
                            oldNavigating !== newNavigating ||
                            oldDestination !== newDestination ||
                            (!oldNavigating && newNavigating) ||
                            (oldNavigating && !newNavigating)
                        );
                        if (shouldRefreshMap) {
                            console.log('ğŸ”„ æ£€æµ‹åˆ°å¯¼èˆªå˜åŒ–ï¼Œå‡†å¤‡åˆ·æ–°åœ°å›¾...');
                            setTimeout(() => {
                                this.refreshMap();
                                console.log('ğŸ—ºï¸ åœ°å›¾å·²åˆ·æ–°');
                            }, 1500);
                        }
                    }

                    // æ›´æ–°éŸ³ä¹çŠ¶æ€
                    if (data.state.music) {
                        console.log('ğŸµ æ›´æ–°éŸ³ä¹çŠ¶æ€:', data.state.music);
                        this.currentSong.title = data.state.music.title || "æ— éŸ³ä¹";
                        this.currentSong.artist = data.state.music.artist || "æœªçŸ¥";
                        this.currentSong.album = data.state.music.album || "æœªçŸ¥ä¸“è¾‘";
                        this.currentSong.file_path = data.state.music.file_path || "";
                        this.currentSong.is_playing = data.state.music.is_playing || false;
                        this.currentSong.is_paused = data.state.music.is_paused || false;
                        this.currentSong.progress = data.state.music.progress || 0;
                        this.currentSong.duration = data.state.music.duration || 0;
                        this.currentSong.progress_percentage = data.state.music.progress_percentage || 0;
                        this.currentSong.volume = data.state.music.volume || 50;
                        this.currentSong.total_files = data.state.music.total_files || 0;
                        this.currentSong.current_index = data.state.music.current_index || 0;
                        this.currentSong.shuffle_mode = data.state.music.shuffle_mode || false;
                        this.currentSong.repeat_mode = data.state.music.repeat_mode || 'none';
                        this.currentSong.current_time_str = data.state.music.current_time_str || '0:00';
                        this.currentSong.total_time_str = data.state.music.total_time_str || '0:00';
                        this.currentSong.playlist = data.state.music.playlist || [];
                        this.updatePlayButton();
                        this.updateMusicDisplay();
                        this.updateVolumeDisplay();
                        this.updatePlaylistInfo();
                    }

                    // æ›´æ–°ç©ºè°ƒçŠ¶æ€
                    if (data.state.ac) {
                        console.log('â„ï¸ æ›´æ–°ç©ºè°ƒçŠ¶æ€:', data.state.ac);
                        this.systemData.temperature = data.state.ac.temperature || this.systemData.temperature;
                        this.systemData.acOn = data.state.ac.is_on || false;
                        const acBtn = document.getElementById('acToggleBtn');
                        if (acBtn) {
                            if (this.systemData.acOn) {
                                acBtn.classList.add('active');
                            } else {
                                acBtn.classList.remove('active');
                            }
                        }
                        const tempElement = document.getElementById('temperature');
                        if (tempElement) {
                            tempElement.textContent = this.systemData.temperature + 'Â°C';
                        }
                        const acStatusElement = document.getElementById('acStatus');
                        if (acStatusElement) {
                            acStatusElement.textContent = this.systemData.acOn ? 'å¼€å¯' : 'å…³é—­';
                        }
                    }

                    // æ›´æ–°è½¦çª—çŠ¶æ€
                    if (data.state.windows) {
                        console.log('ğŸªŸ è½¦çª—çŠ¶æ€æ›´æ–°:', data.state.windows);
                    }

                    // æ›´æ–°ç¯å…‰çŠ¶æ€
                    if (data.state.lights) {
                        console.log('ğŸ’¡ æ›´æ–°ç¯å…‰çŠ¶æ€:', data.state.lights);
                        const headlightsBtn = document.getElementById('headlightsBtn');
                        if (headlightsBtn && data.state.lights.headlights !== undefined) {
                            if (data.state.lights.headlights) {
                                headlightsBtn.classList.add('active');
                            } else {
                                headlightsBtn.classList.remove('active');
                            }
                        }
                        const interiorBtn = document.getElementById('interiorBtn');
                        if (interiorBtn && data.state.lights.interior !== undefined) {
                            if (data.state.lights.interior) {
                                interiorBtn.classList.add('active');
                            } else {
                                interiorBtn.classList.remove('active');
                            }
                        }
                    }

                    // æ›´æ–°é©¾é©¶å‘˜çŠ¶æ€
                    if (data.state.driver) {
                        const driverStateElement = document.getElementById('driverState');
                        if (driverStateElement) {
                            driverStateElement.textContent = data.state.driver.state;
                        }
                    }

                    // æ›´æ–°æ‰‹åŠ¿çŠ¶æ€
                    if (data.state.gesture) {
                        const gestureStateElement = document.getElementById('gestureState');
                        if (gestureStateElement) {
                            gestureStateElement.textContent = data.state.gesture.current;
                        }
                    }
                }

                // æ›´æ–°å‘½ä»¤å†å²
                if (data.command_history && Array.isArray(data.command_history)) {
                    console.log('ğŸ“œ æ›´æ–°å‘½ä»¤å†å²:', data.command_history.length, 'æ¡è®°å½•');
                    this.commandHistory = data.command_history;
                    this.updateCommandHistory();
                }

                // æ˜¾ç¤ºæ‰§è¡Œç»“æœ
                if (data.result) {
                    console.log('âœ… æ˜¾ç¤ºæ“ä½œç»“æœ:', data.result);
                    this.showNotification(data.result, 'success');
                    if (data.result.includes('å¼€å§‹å¯¼èˆª') || data.result.includes('å¯¼èˆªåˆ°') ||
                        data.result.includes('è·¯çº¿') || data.result.includes('è§„åˆ’') ||
                        data.result.includes('å¯¼èˆªå¼€å§‹')) {
                        console.log('ğŸ§­ æ£€æµ‹åˆ°å¯¼èˆªå¼€å§‹ç»“æœï¼Œå¼ºåˆ¶åˆ·æ–°åœ°å›¾');
                        setTimeout(() => {
                            this.loadNavigationStatus();
                            this.refreshMap();
                        }, 2000);
                    } else if (data.result.includes('å¯¼èˆªå·²åœæ­¢') || data.result.includes('åœæ­¢å¯¼èˆª')) {
                        console.log('ğŸ›‘ æ£€æµ‹åˆ°å¯¼èˆªåœæ­¢ç»“æœï¼Œåˆ·æ–°åœ°å›¾');
                        setTimeout(() => {
                            this.loadNavigationStatus();
                            this.refreshMap();
                        }, 1000);
                    }
                }
                console.log('ğŸ”„ ç³»ç»ŸçŠ¶æ€æ›´æ–°å¤„ç†å®Œæˆ');
            }

            // ============ å…¶ä»–æ–¹æ³•ä¿æŒä¸å˜ï¼ˆä¸ºèŠ‚çœç©ºé—´è¿™é‡Œçœç•¥å…·ä½“å®ç°ï¼‰ ============
            // åŒ…æ‹¬ï¼š
            // - initMapDisplay()
            // - loadNavigationStatus()
            // - updateNavigationStatus()
            // - refreshMap()
            // - startNavigation()
            // - stopNavigation()
            // - éŸ³ä¹æ§åˆ¶æ–¹æ³•
            // - ç©ºè°ƒæ§åˆ¶æ–¹æ³•
            // - ç­‰ç­‰...

            // ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡ŒåªåŒ…å«æ ¸å¿ƒçš„ä¸åŒä¹‹å¤„
            initMapDisplay() {
                console.log('ğŸ—ºï¸ åˆå§‹åŒ–åœ°å›¾æ˜¾ç¤º...');
                const mapFrame = document.getElementById('mapFrame');
                const mapPlaceholder = document.getElementById('mapPlaceholder');
                const mapLoading = document.getElementById('mapLoading');
                const navigationStatusIndicator = document.getElementById('navigationStatusIndicator');
                const navigationDot = document.getElementById('navigationDot');
                const navigationStatus = document.getElementById('navigationStatus');

                setTimeout(() => {
                    mapFrame.onload = () => {
                        console.log('âœ… åœ°å›¾åŠ è½½æˆåŠŸ');
                        this.mapLoaded = true;
                        mapFrame.style.display = 'block';
                        mapPlaceholder.style.display = 'none';
                        mapLoading.style.display = 'none';
                        navigationStatusIndicator.className = 'navigation-status ready';
                        document.getElementById('navigationStatusText').textContent = 'å¯¼èˆªç³»ç»Ÿå°±ç»ª';
                        navigationDot.className = 'status-dot active';
                        navigationStatus.textContent = 'åœ°å›¾å°±ç»ª';
                        this.showNotification('åœ°å›¾ç³»ç»Ÿå·²å°±ç»ª', 'success');
                    };

                    mapFrame.onerror = (error) => {
                        console.error('âŒ åœ°å›¾åŠ è½½å¤±è´¥:', error);
                        this.mapLoaded = false;
                        mapFrame.style.display = 'none';
                        mapPlaceholder.style.display = 'block';
                        mapLoading.textContent = 'åœ°å›¾åŠ è½½å¤±è´¥';
                        navigationStatusIndicator.className = 'navigation-status error';
                        document.getElementById('navigationStatusText').textContent = 'åœ°å›¾é”™è¯¯';
                        navigationDot.className = 'status-dot error';
                        navigationStatus.textContent = 'åœ°å›¾å¼‚å¸¸';
                        setTimeout(() => {
                            console.log('ğŸ”„ å°è¯•é‡æ–°åŠ è½½åœ°å›¾...');
                            mapFrame.src = '/map?' + new Date().getTime();
                        }, 5000);
                    };

                    mapFrame.src = '/map?' + new Date().getTime();
                }, 3000);

                setTimeout(() => {
                    if (!this.mapLoaded) {
                        console.warn('âš ï¸ åœ°å›¾åŠ è½½è¶…æ—¶');
                        mapLoading.textContent = 'åœ°å›¾è¿æ¥è¶…æ—¶ï¼Œå°è¯•é‡æ–°è¿æ¥...';
                        navigationStatusIndicator.className = 'navigation-status error';
                        document.getElementById('navigationStatusText').textContent = 'è¿æ¥è¶…æ—¶';
                        navigationDot.className = 'status-dot warning';
                        navigationStatus.textContent = 'åœ°å›¾è¶…æ—¶';
                    }
                }, 15000);
            }

            // ============ ä¿ç•™çš„æ ¸å¿ƒæ–¹æ³• ============
            loadNavigationStatus() {
                fetch('/api/navigation_status')
                    .then(response => {
                        if (response.status === 401) {
                            window.location.href = '/login';
                            return;
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('ğŸ§­ å¯¼èˆªçŠ¶æ€:', data);
                        this.updateNavigationStatus(data);
                    })
                    .catch(error => {
                        console.error('âŒ è·å–å¯¼èˆªçŠ¶æ€å¤±è´¥:', error);
                    });
            }

            updateNavigationStatus(data) {
                if (!data) return;
                this.navigationData = { ...this.navigationData, ...data };
                const currentLocationEl = document.getElementById('currentLocation');
                const navCurrentLocationEl = document.getElementById('navCurrentLocation');
                const navDestinationEl = document.getElementById('navDestination');
                const navDistanceEl = document.getElementById('navDistance');
                const navDurationEl = document.getElementById('navDuration');
                const navStatusEl = document.getElementById('navStatus');
                const navigationStatusIndicator = document.getElementById('navigationStatusIndicator');
                const navigationStatusText = document.getElementById('navigationStatusText');
                const quickStopBtn = document.getElementById('quickStopBtn');

                if (data.current_location) {
                    const locationText = data.current_location.address || 'å·²å®šä½';
                    if (currentLocationEl) currentLocationEl.textContent = locationText;
                    if (navCurrentLocationEl) navCurrentLocationEl.textContent = `å½“å‰ä½ç½®: ${locationText}`;
                }

                if (data.is_navigating && data.destination) {
                    if (navDestinationEl) navDestinationEl.textContent = `ç›®çš„åœ°: ${data.destination.name || data.destination.address}`;
                    if (navStatusEl) {
                        navStatusEl.textContent = 'çŠ¶æ€: å¯¼èˆªä¸­';
                        navStatusEl.className = 'navigation-info navigating';
                    }
                    if (navigationStatusIndicator) {
                        navigationStatusIndicator.className = 'navigation-status navigating';
                    }
                    if (navigationStatusText) {
                        navigationStatusText.textContent = `å¯¼èˆªè‡³ ${data.destination.name || data.destination.address}`;
                    }
                    if (quickStopBtn) {
                        quickStopBtn.style.display = 'block';
                    }
                    const navigationDot = document.getElementById('navigationDot');
                    const navigationStatus = document.getElementById('navigationStatus');
                    if (navigationDot) navigationDot.className = 'status-dot active';
                    if (navigationStatus) navigationStatus.textContent = 'å¯¼èˆªä¸­';
                } else {
                    if (navDestinationEl) navDestinationEl.textContent = 'ç›®çš„åœ°: æœªè®¾ç½®';
                    if (navStatusEl) {
                        navStatusEl.textContent = 'çŠ¶æ€: å°±ç»ª';
                        navStatusEl.className = 'navigation-info ready';
                    }
                    if (navigationStatusIndicator) {
                        navigationStatusIndicator.className = 'navigation-status ready';
                    }
                    if (navigationStatusText) {
                        navigationStatusText.textContent = 'å¯¼èˆªç³»ç»Ÿå°±ç»ª';
                    }
                    if (quickStopBtn) {
                        quickStopBtn.style.display = 'none';
                    }
                    const navigationDot = document.getElementById('navigationDot');
                    const navigationStatus = document.getElementById('navigationStatus');
                    if (navigationDot) navigationDot.className = 'status-dot active';
                    if (navigationStatus) navigationStatus.textContent = 'åœ°å›¾å°±ç»ª';
                }

                if (navDistanceEl) navDistanceEl.textContent = `è·ç¦»: ${data.distance || '--'}`;
                if (navDurationEl) navDurationEl.textContent = `é¢„è®¡æ—¶é—´: ${data.duration || '--'}`;
            }

            refreshMap() {
                console.log('ğŸ”„ å¼€å§‹åˆ·æ–°åœ°å›¾...');
                const mapFrame = document.getElementById('mapFrame');
                if (mapFrame) {
                    const timestamp = new Date().getTime();
                    const random = Math.random().toString(36).substring(7);
                    mapFrame.src = `/map?t=${timestamp}&r=${random}`;
                    console.log(`ğŸ—ºï¸ åœ°å›¾URLå·²æ›´æ–°: /map?t=${timestamp}&r=${random}`);
                    this.showNotification('æ­£åœ¨åˆ·æ–°åœ°å›¾...', 'info');
                    mapFrame.onload = () => {
                        console.log('âœ… åœ°å›¾åˆ·æ–°å®Œæˆ');
                        this.showNotification('åœ°å›¾å·²æ›´æ–°', 'success');
                    };
                    mapFrame.onerror = () => {
                        console.error('âŒ åœ°å›¾åˆ·æ–°å¤±è´¥');
                        this.showNotification('åœ°å›¾åˆ·æ–°å¤±è´¥', 'error');
                    };
                } else {
                    console.error('âŒ æœªæ‰¾åˆ°åœ°å›¾å…ƒç´ ');
                }
            }

            startNavigation() {
                const destinationInput = document.getElementById('destinationInput');
                const destination = destinationInput.value.trim();
                if (!destination) {
                    this.showNotification('è¯·è¾“å…¥ç›®çš„åœ°', 'warning');
                    return;
                }
                console.log(`ğŸ§­ å¼€å§‹å¯¼èˆªåˆ°: ${destination}`);
                this.sendCommand('navigation', `å¯¼èˆªåˆ°${destination}`);
                this.addCommand('å¯¼èˆª', `å¯¼èˆªåˆ°${destination}`);
                this.showNotification(`æ­£åœ¨è§„åˆ’åˆ° ${destination} çš„è·¯çº¿...`, 'info');
                destinationInput.value = '';
            }

            stopNavigation() {
                console.log('ğŸ›‘ åœæ­¢å¯¼èˆª');
                fetch('/api/stop_navigation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ›‘ åœæ­¢å¯¼èˆªç»“æœ:', data);
                    if (data.status === 'success') {
                        this.showNotification(data.message, 'success');
                        this.refreshMap();
                        this.loadNavigationStatus();
                    } else {
                        this.showNotification('åœæ­¢å¯¼èˆªå¤±è´¥: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('âŒ åœæ­¢å¯¼èˆªå¤±è´¥:', error);
                    this.showNotification('åœæ­¢å¯¼èˆªå¤±è´¥', 'error');
                });
                this.addCommand('å¯¼èˆª', 'åœæ­¢å¯¼èˆª');
            }

            checkNavigationStatus() {
                console.log('ğŸ§­ æ£€æŸ¥å¯¼èˆªçŠ¶æ€...');
                this.loadNavigationStatus();
                this.showNotification('å¯¼èˆªçŠ¶æ€å·²æ›´æ–°', 'info');
            }

            requestSystemState() {
                console.log('ğŸ“¡ è¯·æ±‚ç³»ç»ŸçŠ¶æ€...');
                if (this.socket && this.socket.connected) {
                    this.socket.emit('request_system_state');
                    console.log('ğŸ“¤ å·²å‘é€çŠ¶æ€è¯·æ±‚');
                } else {
                    console.warn('âš ï¸ æ— æ³•å‘é€çŠ¶æ€è¯·æ±‚ï¼Œè¿æ¥æœªå»ºç«‹');
                }
            }

            testConnection() {
                console.log('ğŸ§ª æµ‹è¯•WebSocketè¿æ¥...');
                if (this.socket && this.socket.connected) {
                    this.socket.emit('test_connection', {
                        message: 'å‰ç«¯æµ‹è¯•æ¶ˆæ¯',
                        timestamp: new Date().toISOString()
                    });
                    console.log('ğŸ“¤ å·²å‘é€æµ‹è¯•æ¶ˆæ¯');
                } else {
                    console.error('âŒ è¿æ¥æœªå»ºç«‹ï¼Œæ— æ³•æµ‹è¯•');
                    this.showNotification('è¿æ¥æœªå»ºç«‹', 'error');
                }
            }

            checkVoiceStatus() {
                console.log('ğŸ¤ æ£€æŸ¥è¯­éŸ³è¯†åˆ«çŠ¶æ€...');
                fetch('/api/voice_status')
                    .then(response => {
                        if (response.status === 401) {
                            window.location.href = '/login';
                            return;
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('ğŸ¤ è¯­éŸ³çŠ¶æ€:', data);
                        let statusText = '';
                        if (data.voice_recognition_enabled) {
                            statusText = `è¯­éŸ³è¯†åˆ«: ${data.is_running ? 'è¿è¡Œä¸­' : 'æœªè¿è¡Œ'}, `;
                            statusText += `è¿æ¥: ${data.is_connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}, `;
                            statusText += `å½•éŸ³: ${data.is_recording ? 'å½•éŸ³ä¸­' : 'å¾…æœº'}`;
                        } else {
                            statusText = 'è¯­éŸ³è¯†åˆ«æœªå¯ç”¨';
                        }
                        this.showNotification(statusText, 'info');
                        console.log('ğŸ¤ è¯­éŸ³çŠ¶æ€è¯¦æƒ…:', statusText);
                    })
                    .catch(error => {
                        console.error('âŒ è·å–è¯­éŸ³çŠ¶æ€å¤±è´¥:', error);
                        this.showNotification('è·å–è¯­éŸ³çŠ¶æ€å¤±è´¥', 'error');
                    });
            }

            testVoiceCommand() {
                console.log('ğŸ§ª æµ‹è¯•è¯­éŸ³æŒ‡ä»¤...');
                const testCommands = ['å¼€ç©ºè°ƒ', 'æ’­æ”¾éŸ³ä¹', 'å‡æ¸©', 'ä¸‹ä¸€é¦–', 'å¯¼èˆªåˆ°å¤©æ´¥ç«™'];
                const randomCommand = testCommands[Math.floor(Math.random() * testCommands.length)];
                fetch('/api/test_voice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: randomCommand
                    })
                })
                .then(response => {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ§ª è¯­éŸ³æµ‹è¯•ç»“æœ:', data);
                    this.showNotification(`æµ‹è¯•æŒ‡ä»¤: ${randomCommand}`, 'info');
                })
                .catch(error => {
                    console.error('âŒ è¯­éŸ³æµ‹è¯•å¤±è´¥:', error);
                    this.showNotification('è¯­éŸ³æµ‹è¯•å¤±è´¥', 'error');
                });
            }

            updateConnectionStatus(connected) {
                const connectionDot = document.getElementById('connectionDot');
                const connectionStatus = document.getElementById('connectionStatus');
                if (connected) {
                    connectionDot.className = 'status-dot active';
                    connectionStatus.textContent = 'å·²è¿æ¥';
                } else {
                    connectionDot.className = 'status-dot error';
                    connectionStatus.textContent = 'è¿æ¥æ–­å¼€';
                }
            }

            sendCommand(type, text) {
                if (this.socket && this.socket.connected) {
                    this.socket.emit('manual_command', {
                        type: type,
                        text: text
                    });
                } else {
                    this.showNotification('æœªè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                }
            }

            addCommand(type, text) {
                const command = {
                    type: type,
                    text: text,
                    time: new Date().toLocaleTimeString()
                };
                this.commandHistory.unshift(command);
                if (this.commandHistory.length > 5) {
                    this.commandHistory.pop();
                }
                this.updateCommandHistory();
            }

            updateCommandHistory() {
                const historyContainer = document.getElementById('commandHistory');
                historyContainer.innerHTML = '';
                this.commandHistory.forEach(cmd => {
                    const item = document.createElement('div');
                    item.className = 'command-item slide-in';
                    const typeClass = cmd.type === 'è¯­éŸ³' ? 'voice' :
                                     cmd.type === 'æ‰‹åŠ¿' ? 'gesture' :
                                     cmd.type === 'å¯¼èˆª' ? 'navigation' : 'system';
                    item.innerHTML = `
                        <span class="command-type ${typeClass}">${cmd.type}</span>
                        <span class="command-text">${cmd.text}</span>
                        <span class="command-time">${cmd.time}</span>
                    `;
                    historyContainer.appendChild(item);
                });
            }

            updatePlayButton() {
                const playBtn = document.getElementById('musicPlayBtn');
                const playPauseBtn = document.getElementById('playPauseBtn');
                if (playBtn) {
                    let icon;
                    if (this.currentSong.is_playing && !this.currentSong.is_paused) {
                        icon = 'â¸ï¸';
                    } else {
                        icon = 'â–¶ï¸';
                    }
                    playBtn.textContent = icon;
                }
                if (playPauseBtn) {
                    const span = playPauseBtn.querySelector('span');
                    if (span) {
                        span.textContent = this.currentSong.is_playing && !this.currentSong.is_paused ? 'â¸ï¸' : 'â–¶ï¸';
                    }
                }
            }

            updateMusicDisplay() {
                const titleElement = document.getElementById('songTitle');
                if (titleElement) titleElement.textContent = this.currentSong.title;
                const artistElement = document.getElementById('songArtist');
                if (artistElement) artistElement.textContent = this.currentSong.artist;
                const progressFill = document.getElementById('progressFill');
                if (progressFill) {
                    progressFill.style.width = (this.currentSong.progress_percentage || 0) + '%';
                }
                const currentTimeEl = document.getElementById('currentTime');
                const totalTimeEl = document.getElementById('totalTime');
                if (currentTimeEl) currentTimeEl.textContent = this.currentSong.current_time_str;
                if (totalTimeEl) totalTimeEl.textContent = this.currentSong.total_time_str;
            }

            updateVolumeDisplay() {
                // éŸ³é‡æ˜¾ç¤ºæ›´æ–°é€»è¾‘ï¼ˆå¦‚æœéœ€è¦ï¼‰
            }

            updatePlaylistInfo() {
                // æ’­æ”¾åˆ—è¡¨ä¿¡æ¯æ›´æ–°é€»è¾‘ï¼ˆå¦‚æœéœ€è¦ï¼‰
            }

            // ============ äº‹ä»¶ç»‘å®šæ–¹æ³• ============
            bindEvents() {
                // å¯¼èˆªæ§åˆ¶æŒ‰é’®
                document.getElementById('startNavigationBtn')?.addEventListener('click', () => {
                    this.startNavigation();
                    setTimeout(() => {
                        console.log('ğŸ”„ å¯¼èˆªå¼€å§‹åè‡ªåŠ¨åˆ·æ–°åœ°å›¾');
                        this.loadNavigationStatus();
                        this.refreshMap();
                    }, 3000);
                });

                document.getElementById('stopNavigationBtn')?.addEventListener('click', () => {
                    this.stopNavigation();
                    setTimeout(() => {
                        console.log('ğŸ”„ åœæ­¢å¯¼èˆªåè‡ªåŠ¨åˆ·æ–°åœ°å›¾');
                        this.refreshMap();
                    }, 1500);
                });

                document.getElementById('quickStopBtn')?.addEventListener('click', () => {
                    this.stopNavigation();
                    setTimeout(() => {
                        this.refreshMap();
                    }, 1500);
                });

                document.getElementById('refreshMapBtn')?.addEventListener('click', () => {
                    this.refreshMap();
                });

                // ç›®çš„åœ°è¾“å…¥æ¡†å›è½¦äº‹ä»¶
                document.getElementById('destinationInput')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.startNavigation();
                    }
                });

                // éŸ³ä¹æ§åˆ¶æŒ‰é’®
                document.getElementById('playPauseBtn')?.addEventListener('click', () => this.toggleMusic());
                document.getElementById('musicPlayBtn')?.addEventListener('click', () => this.toggleMusic());
                document.getElementById('nextBtn')?.addEventListener('click', () => this.nextSong());
                document.getElementById('musicNextBtn')?.addEventListener('click', () => this.nextSong());
                document.getElementById('prevBtn')?.addEventListener('click', () => this.prevSong());
                document.getElementById('musicPrevBtn')?.addEventListener('click', () => this.prevSong());
                document.getElementById('shuffleBtn')?.addEventListener('click', () => this.shuffleMusic());

                // ç©ºè°ƒæ§åˆ¶
                document.getElementById('acToggleBtn')?.addEventListener('click', () => this.toggleAC());
                document.getElementById('tempUpBtn')?.addEventListener('click', () => this.adjustTemperature(1));
                document.getElementById('tempDownBtn')?.addEventListener('click', () => this.adjustTemperature(-1));

                // è½¦çª—æ§åˆ¶
                document.getElementById('windowOpenBtn')?.addEventListener('click', () => this.controlWindow('open'));
                document.getElementById('windowCloseBtn')?.addEventListener('click', () => this.controlWindow('close'));

                // ç¯å…‰æ§åˆ¶
                document.getElementById('headlightsBtn')?.addEventListener('click', () => this.toggleLights('headlights'));
                document.getElementById('interiorBtn')?.addEventListener('click', () => this.toggleLights('interior'));
            }

            // ============ æ§åˆ¶æ–¹æ³• ============
            toggleMusic() {
                let command;
                if (this.currentSong.is_playing && !this.currentSong.is_paused) {
                    command = 'æš‚åœ';
                } else if (this.currentSong.is_paused) {
                    command = 'æ’­æ”¾';
                } else {
                    command = 'æ’­æ”¾';
                }
                this.sendCommand('music', command);
                this.addCommand('æ‰‹åŠ¨', command);
            }

            nextSong() {
                this.sendCommand('music', 'ä¸‹ä¸€é¦–');
                this.addCommand('éŸ³ä¹', 'ä¸‹ä¸€é¦–');
            }

            prevSong() {
                this.sendCommand('music', 'ä¸Šä¸€é¦–');
                this.addCommand('éŸ³ä¹', 'ä¸Šä¸€é¦–');
            }

            shuffleMusic() {
                this.sendCommand('music', 'éšæœºæ’­æ”¾');
                this.addCommand('æ‰‹åŠ¨', 'éšæœºæ’­æ”¾');
            }

            toggleAC() {
                this.systemData.acOn = !this.systemData.acOn;
                const acBtn = document.getElementById('acToggleBtn');
                if (this.systemData.acOn) {
                    acBtn.classList.add('active');
                } else {
                    acBtn.classList.remove('active');
                }
                this.updateSystemDisplay();
                this.addCommand('ç©ºè°ƒ', this.systemData.acOn ? 'å¼€å¯ç©ºè°ƒ' : 'å…³é—­ç©ºè°ƒ');
                this.showNotification(`ç©ºè°ƒå·²${this.systemData.acOn ? 'å¼€å¯' : 'å…³é—­'}`, 'info');
            }

            adjustTemperature(delta) {
                this.systemData.temperature += delta;
                this.systemData.temperature = Math.max(16, Math.min(32, this.systemData.temperature));
                this.updateSystemDisplay();
                this.addCommand('ç©ºè°ƒ', `æ¸©åº¦è°ƒè‡³ ${this.systemData.temperature}Â°C`);
                this.showNotification(`æ¸©åº¦å·²è°ƒè‡³ ${this.systemData.temperature}Â°C`, 'info');
            }

            controlWindow(action) {
                const message = action === 'open' ? 'å¼€å¯è½¦çª—' : 'å…³é—­è½¦çª—';
                this.addCommand('è½¦çª—', message);
                this.showNotification(message, 'info');
            }

            toggleLights(type) {
                const lightNames = {
                    'headlights': 'å¤§ç¯',
                    'interior': 'å®¤å†…ç¯'
                };
                const btn = document.getElementById(type + 'Btn');
                const isActive = btn.classList.contains('active');
                if (isActive) {
                    btn.classList.remove('active');
                } else {
                    btn.classList.add('active');
                }
                const message = `${lightNames[type]}å·²${isActive ? 'å…³é—­' : 'å¼€å¯'}`;
                this.addCommand('ç¯å…‰', message);
                this.showNotification(message, 'info');
            }

            updateSystemDisplay() {
                document.getElementById('temperature').textContent = this.systemData.temperature + 'Â°C';
                document.getElementById('acStatus').textContent = this.systemData.acOn ? 'å¼€å¯' : 'å…³é—­';
                document.getElementById('engineStatus').textContent = this.systemData.engineOn ? 'å¯åŠ¨' : 'åœæ­¢';
                document.getElementById('fuelLevel').textContent = this.systemData.fuelLevel + '%';
                document.getElementById('speed').textContent = this.systemData.speed + ' km/h';
                document.getElementById('gear').textContent = this.systemData.gear;
            }

            updateDisplay() {
                this.updateMusicDisplay();
                this.updateSystemDisplay();
            }

            startSystemMonitor() {
                setInterval(() => {
                    document.getElementById('cpuUsage').textContent = (30 + Math.random() * 20).toFixed(0) + '%';
                    document.getElementById('memoryUsage').textContent = (40 + Math.random() * 15).toFixed(0) + '%';
                    document.getElementById('systemTemp').textContent = (42 + Math.random() * 8).toFixed(0) + 'Â°C';
                }, 3000);

                setInterval(() => {
                    if (this.socket) {
                        if (!this.socket.connected) {
                            console.warn('âš ï¸ æ£€æµ‹åˆ°WebSocketè¿æ¥æ–­å¼€ï¼Œå°è¯•é‡è¿...');
                            this.updateConnectionStatus(false);
                            this.socket.connect();
                        }
                    }
                }, 10000);
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                const colors = {
                    success: 'linear-gradient(135deg, #00ff88, #32cd32)',
                    error: 'linear-gradient(135deg, #ff6b6b, #ff4444)',
                    warning: 'linear-gradient(135deg, #ffaa00, #ff8c00)',
                    info: 'linear-gradient(135deg, #00d4ff, #5b86e5)'
                };

                notification.style.cssText = `
                    position: fixed;
                    top: 100px;
                    right: 30px;
                    background: ${colors[type]};
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    z-index: 1000;
                    animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-out 2.7s;
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    max-width: 300px;
                    word-wrap: break-word;
                `;
                notification.textContent = message;

                document.body.appendChild(notification);

                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 3000);
            }

            startTimeUpdate() {
                setInterval(() => {
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });
                    const systemTimeEl = document.getElementById('systemTime');
                    if (systemTimeEl) systemTimeEl.textContent = timeStr;
                }, 1000);
            }
        }

        // åˆå§‹åŒ–ç³»ç»Ÿ
        document.addEventListener('DOMContentLoaded', () => {
            window.carSystem = new CarSystemUI();
            console.log('ğŸš— è½¦è½½å¤šæ¨¡æ€äº¤äº’ç³»ç»Ÿç•Œé¢å·²å¯åŠ¨ï¼ˆè®¤è¯ç‰ˆæœ¬ï¼‰');
            console.log('ğŸ”§ carSystemå®ä¾‹å·²åˆ›å»ºå¹¶è®¾ä¸ºå…¨å±€å˜é‡');
        });

        // æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>